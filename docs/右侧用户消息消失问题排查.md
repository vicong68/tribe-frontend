# 右侧用户消息消失问题排查

## 一、问题现象

**问题描述**：在左侧接收 agents 消息开始后，右侧用户刚发送的那一条正常显示的消息（左侧正在渲染消息的前一条消息），完全看不到了。仅有左侧 agent 回复消息正常。之后，即使接收完左侧消息，右侧那一条关联消息也不会正常显示（其他历史消息则显示正常）。手动刷新页面才能显示正常。

## 二、日志分析

### 2.1 消息过滤和渲染日志

从日志来看：
1. ✅ **最后一条用户消息在输出中**：`id: "e4fd6a1e-3aaa-4b93-b490-24b1f7270305"`，index 31
2. ✅ **消息被渲染**：日志显示该用户消息被渲染（`[Messages] 渲染消息`）
3. ✅ **消息内容正常**：所有用户消息的 `[PreviewMessage] 用户消息渲染检查` 都显示 `hasContent: true`

### 2.2 关键发现

**消息索引不一致**：
- 在 `uniqueMessages` 中：`indexInInput: 15, indexInOutput: 15`
- 在 `Messages` 渲染中：`index: 31`

这表明消息顺序可能有问题，但消息确实在列表中。

## 三、可能的原因

### 3.1 CSS 样式问题

**可能的问题**：
- `fade-in` 和 `animate-in` 动画类可能在动画过程中导致消息不可见
- 消息可能被其他元素遮挡（z-index 问题）
- 消息的 `opacity` 或 `visibility` 可能被设置为不可见

**已添加的修复**：
- 在消息组件上添加了显式的样式：`opacity: 1, visibility: "visible"`
- 添加了 `minHeight: "1px"` 确保消息有高度

### 3.2 滚动位置问题

**可能的问题**：
- 消息在视口外，需要滚动才能看到
- 自动滚动逻辑可能没有正确触发
- `isAtBottom` 状态可能不准确

**已添加的追踪**：
- 添加了滚动位置和消息可见性的日志
- 检查消息是否在视口中（`isInViewport`）

### 3.3 React key 问题

**可能的问题**：
- 如果 key 不稳定，React 可能会重新挂载组件
- `PreviewMessage` 的 memo 比较函数可能有问题

**已修复的问题**：
- 修复了 `PreviewMessage` 的 memo 比较函数（之前总是返回 `false`，现在正确返回 `true` 或 `false`）
- 确保 key 使用稳定的 `message.id`

### 3.4 requiresScrollPadding 问题

**已修复的问题**：
- 修复了 `requiresScrollPadding` 的判断逻辑，从 `index === messages.length - 1` 改为 `index === uniqueMessages.length - 1`

## 四、已添加的调试工具

### 4.1 DOM 渲染状态追踪

**位置**：`message.tsx:506-530`

```typescript
useEffect(() => {
  if (process.env.NODE_ENV === "development" && isLocalUser && messageRef.current) {
    const element = messageRef.current;
    const rect = element.getBoundingClientRect();
    const isVisible = rect.width > 0 && rect.height > 0;
    const isInViewport = rect.top >= 0 && rect.bottom <= window.innerHeight;
    
    console.log("[PreviewMessage] DOM 渲染状态:", {
      id: message.id,
      isVisible,
      isInViewport,
      rect: { ... },
      computedStyle: { ... },
    });
  }
}, [message.id, isLocalUser, messageContent]);
```

**作用**：
- 检查消息的 DOM 元素是否可见
- 检查消息是否在视口中
- 检查消息的计算样式（display, visibility, opacity, height）

### 4.2 滚动位置追踪

**位置**：`messages.tsx:166-200`

```typescript
useEffect(() => {
  if (process.env.NODE_ENV === "development" && messagesContainerRef.current) {
    const container = messagesContainerRef.current;
    const lastUserMessage = uniqueMessages.filter(m => m.role === "user").slice(-1)[0];
    
    if (lastUserMessage) {
      const messageElement = container.querySelector(`[data-message-id="${lastUserMessage.id}"]`);
      if (messageElement) {
        // 检查滚动位置和消息可见性
        console.log("[Messages] 滚动位置和消息可见性:", { ... });
      }
    }
  }
}, [uniqueMessages, messagesContainerRef]);
```

**作用**：
- 检查最后一条用户消息的 DOM 元素是否存在
- 检查滚动位置和消息可见性
- 检查消息是否在视口中

## 五、下一步排查

请再次测试，并查看控制台日志，重点关注：

1. **`[PreviewMessage] DOM 渲染状态`**：
   - `isVisible` - 消息是否可见（width > 0 && height > 0）
   - `isInViewport` - 消息是否在视口中
   - `computedStyle` - 消息的计算样式

2. **`[Messages] 滚动位置和消息可见性`**：
   - `isVisible` - 消息是否可见
   - `isInViewport` - 消息是否在视口中
   - `scrollTop`, `scrollHeight`, `clientHeight` - 滚动位置信息
   - `isAtBottom` - 是否在底部

3. **`[Messages] 渲染最后一条用户消息`**：
   - 确认最后一条用户消息是否被渲染
   - 确认 key 是否稳定

## 六、可能的解决方案

### 6.1 如果消息不在视口中

**解决方案**：
- 确保自动滚动逻辑正确触发
- 在流式传输开始时，强制滚动到底部

### 6.2 如果消息被 CSS 隐藏

**解决方案**：
- 检查并修复 CSS 样式
- 确保动画类不会导致消息不可见

### 6.3 如果消息被 React 重新挂载

**解决方案**：
- 确保 key 稳定
- 修复 memo 比较函数

## 七、验证方法

1. **检查 DOM 元素**：
   - 在浏览器开发者工具中，使用 `document.querySelector('[data-message-id="e4fd6a1e-3aaa-4b93-b490-24b1f7270305"]')` 查找消息元素
   - 检查元素的计算样式和位置

2. **检查滚动位置**：
   - 在浏览器开发者工具中，检查容器的 `scrollTop` 和 `scrollHeight`
   - 确认消息是否在视口中

3. **检查 React 组件**：
   - 使用 React DevTools 检查组件树
   - 确认消息组件是否被正确渲染

