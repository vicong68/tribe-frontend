# 页面刷新问题分析

## 问题 1: SSE 连接错误

### 现象
刷新页面后，控制台报错：
```
加载页面时与 http://localhost:8000/api/sse/events/RedWM?heartbeat_interval=30 的连接中断
[SSE] SSE 错误
[SSE] SSE readyState: 2 (CLOSED)
```

### 原因分析
1. **用户ID提取问题**：
   - `websocket-message-provider.tsx` 从 session.email 提取用户ID：`email.split("@")[0]`
   - "RedWM" 可能不是正确的后端用户ID格式
   - 应该使用 `session.user.memberId` 或从 email 正确提取

2. **连接时机问题**：
   - SSE 连接在页面加载时立即建立
   - 此时 session 可能还未完全初始化
   - 后端服务可能还未准备好

3. **错误处理不足**：
   - 连接失败时没有优雅降级
   - 错误日志过多，影响用户体验

### 解决方案
1. 优化用户ID提取逻辑，优先使用 `memberId`
2. 延迟 SSE 连接建立，等待 session 完全初始化
3. 添加连接状态检查，避免无效连接
4. 优化错误日志，减少控制台噪音

## 问题 2: 历史 agent 回复消失

### 现象
刷新页面后，之前 agent 的回复消息消失

### 原因分析
1. **消息保存时机**：
   - 从代码看，assistant 消息在流式响应完成后通过 `onFinish` 回调保存
   - 但如果页面在保存完成前刷新，消息会丢失

2. **消息加载问题**：
   - `chat/[id]/page.tsx` 会从数据库加载消息
   - 但如果消息未保存，加载时会丢失

3. **消息持久化检查**：
   - `useMessagePersistence` hook 会在页面加载时检查并保存未保存的消息
   - 但可能存在问题：
     - 检查时机不对（延迟1秒可能不够）
     - 消息ID匹配问题

### 解决方案
1. 优化消息保存逻辑，确保消息在流式响应过程中就保存
2. 改进消息持久化检查，确保刷新后能恢复未保存的消息
3. 添加消息完整性检查，确保所有消息都正确加载

